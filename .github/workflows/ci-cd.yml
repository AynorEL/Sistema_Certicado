name: CI/CD - SOLO index.php y admin/index.php (SIN herramientas externas)

on:
  push:
    branches: [main, develop]
    paths:
      - "index.php"
      - "admin/index.php"
      - ".github/workflows/ci-cd.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "index.php"
      - "admin/index.php"
      - ".github/workflows/ci-cd.yml"
  release:
    types: [published]

env:
  PHP_VERSION: "8.2"

jobs:
  # ========================================
  # ANÃLISIS BÃSICO SIN HERRAMIENTAS EXTERNAS
  # ========================================
  basic-analysis:
    name: AnÃ¡lisis BÃ¡sico (SOLO 2 archivos)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            index.php
            admin/index.php
          sparse-checkout-cone-mode: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, mysql, gd, zip, curl, xml, dom, pdo, pdo_mysql

      - name: Verificar archivos objetivo
        run: |
          echo "ğŸ” VERIFICANDO ARCHIVOS OBJETIVO..."

          # Listar TODOS los archivos en el workspace
          echo "ğŸ“ Archivos en el workspace:"
          find . -type f -name "*.php" | head -20

          # Verificar que SOLO tenemos los archivos objetivo
          if [ -f "index.php" ] && [ -f "admin/index.php" ]; then
            echo "âœ… Archivos objetivo encontrados"
          else
            echo "âŒ Archivos objetivo NO encontrados"
            exit 1
          fi

          # Contar archivos PHP
          PHP_COUNT=$(find . -name "*.php" | wc -l)
          echo "ğŸ“Š Total archivos PHP encontrados: $PHP_COUNT"

          if [ $PHP_COUNT -gt 2 ]; then
            echo "âš ï¸ ADVERTENCIA: Se encontraron mÃ¡s archivos PHP de los esperados"
            echo "ğŸ“‹ Lista completa:"
            find . -name "*.php"
          fi

      - name: AnÃ¡lisis de sintaxis PHP
        run: |
          echo "ğŸ§ª ANÃLISIS DE SINTAXIS PHP..."

          # Verificar sintaxis de index.php
          echo "Verificando: index.php"
          php -l index.php || exit 1

          # Verificar sintaxis de admin/index.php
          echo "Verificando: admin/index.php"
          php -l admin/index.php || exit 1

          echo "âœ… Sintaxis PHP correcta en ambos archivos"

      - name: AnÃ¡lisis de cÃ³digo bÃ¡sico (SIN herramientas externas)
        run: |
          echo "ğŸ” ANÃLISIS DE CÃ“DIGO BÃSICO..."

          # FunciÃ³n para analizar un archivo
          analyze_file() {
            local file="$1"
            echo ""
            echo "ğŸ” Analizando: $file"
            echo "----------------------------------------"
            
            # Verificar longitud de lÃ­neas
            echo "ğŸ“ LÃ­neas largas (>120 caracteres):"
            awk 'length > 120 { print NR ": " $0 }' "$file" | head -5 || echo "âœ… No encontradas"
            
            # Verificar espacios en blanco al final
            echo "ğŸ”² Espacios en blanco al final:"
            grep -n " $" "$file" | head -3 || echo "âœ… No encontrados"
            
            # Verificar tabulaciones mixtas
            echo "ğŸ”¤ Tabulaciones mixtas:"
            grep -n $'\t' "$file" | head -3 || echo "âœ… No encontradas"
            
            # Verificar etiquetas PHP
            echo "ğŸ·ï¸ Etiquetas PHP:"
            if grep -q "<?php" "$file"; then
              echo "âœ… Contiene etiquetas PHP"
            else
              echo "âŒ No contiene etiquetas PHP"
            fi
            
            # EstadÃ­sticas bÃ¡sicas
            echo "ğŸ“Š EstadÃ­sticas:"
            echo "   - LÃ­neas: $(wc -l < "$file")"
            echo "   - Palabras: $(wc -w < "$file")"
            echo "   - Caracteres: $(wc -c < "$file")"
          }

          # Analizar solo los archivos objetivo
          analyze_file "index.php"
          analyze_file "admin/index.php"

      - name: AnÃ¡lisis de seguridad bÃ¡sico
        run: |
          echo "ğŸ”’ ANÃLISIS DE SEGURIDAD BÃSICO..."

          # FunciÃ³n para escanear seguridad
          security_scan() {
            local file="$1"
            echo ""
            echo "ğŸ”’ Escaneando: $file"
            echo "----------------------------------------"
            
            # Funciones peligrosas
            echo "ğŸš¨ Funciones peligrosas:"
            grep -n "eval\|exec\|system\|shell_exec\|passthru" "$file" || echo "âœ… No encontradas"
            
            # SQL injection bÃ¡sico
            echo "ğŸ—„ï¸ SQL injection potencial:"
            grep -n "SELECT.*\$_\|INSERT.*\$_\|UPDATE.*\$_\|DELETE.*\$_" "$file" || echo "âœ… No encontrado"
            
            # XSS bÃ¡sico
            echo "ğŸ”— XSS potencial:"
            grep -n "echo.*\$_\|print.*\$_" "$file" || echo "âœ… No encontrado"
            
            # Variables superglobales sin validar
            echo "ğŸŒ Variables superglobales:"
            grep -n "\$_GET\|\$_POST\|\$_REQUEST\|\$_COOKIE" "$file" | head -3 || echo "âœ… No encontradas"
            
            # File inclusion
            echo "ğŸ“‚ File inclusion:"
            grep -n "include.*\$\|require.*\$" "$file" || echo "âœ… No encontrado"
          }

          # Escanear solo archivos objetivo
          security_scan "index.php"
          security_scan "admin/index.php"

  # ========================================
  # TESTS FUNCIONALES BÃSICOS
  # ========================================
  functional-tests:
    name: Tests Funcionales (SOLO 2 archivos)
    runs-on: ubuntu-latest
    needs: basic-analysis

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            index.php
            admin/index.php
          sparse-checkout-cone-mode: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, mysql, gd, zip, curl, xml, dom, pdo, pdo_mysql

      - name: Test estructura de archivos
        run: |
          echo "ğŸ§ª TESTING ESTRUCTURA DE ARCHIVOS..."

          # Verificar que solo tenemos 2 archivos
          TOTAL_FILES=$(find . -name "*.php" | wc -l)
          if [ $TOTAL_FILES -eq 2 ]; then
            echo "âœ… Correcto: Solo 2 archivos PHP encontrados"
          else
            echo "âŒ Error: Se encontraron $TOTAL_FILES archivos PHP (esperados: 2)"
            find . -name "*.php"
            exit 1
          fi

      - name: Test contenido bÃ¡sico
        run: |
          echo "ğŸ§ª TESTING CONTENIDO BÃSICO..."

          # Test para index.php
          echo "Testing index.php:"
          if [ -s "index.php" ]; then
            echo "âœ… index.php tiene contenido"
            # Verificar que es un archivo PHP vÃ¡lido
            if head -1 "index.php" | grep -q "<?php"; then
              echo "âœ… index.php comienza con <?php"
            else
              echo "âš ï¸ index.php no comienza con <?php"
            fi
          else
            echo "âŒ index.php estÃ¡ vacÃ­o"
            exit 1
          fi

          # Test para admin/index.php
          echo "Testing admin/index.php:"
          if [ -s "admin/index.php" ]; then
            echo "âœ… admin/index.php tiene contenido"
            # Verificar que es un archivo PHP vÃ¡lido
            if head -1 "admin/index.php" | grep -q "<?php"; then
              echo "âœ… admin/index.php comienza con <?php"
            else
              echo "âš ï¸ admin/index.php no comienza con <?php"
            fi
          else
            echo "âŒ admin/index.php estÃ¡ vacÃ­o"
            exit 1
          fi

      - name: Test parsing PHP
        run: |
          echo "ğŸ§ª TESTING PARSING PHP..."

          # Crear script de test temporal
          cat > test_parse.php << 'EOF'
          <?php
          $files = ['index.php', 'admin/index.php'];

          foreach ($files as $file) {
            echo "Parseando: $file\n";
            
            $content = file_get_contents($file);
            if ($content === false) {
              echo "âŒ Error leyendo $file\n";
              exit(1);
            }
            
            // Verificar que no hay errores de sintaxis bÃ¡sicos
            $tokens = token_get_all($content);
            if (empty($tokens)) {
              echo "âŒ Error parseando $file\n";
              exit(1);
            }
            
            echo "âœ… $file parseado correctamente\n";
          }

          echo "âœ… Todos los archivos parseados correctamente\n";
          EOF

          php test_parse.php

  # ========================================
  # BUILD SUPER SIMPLE
  # ========================================
  build:
    name: Build Simple (SOLO 2 archivos)
    runs-on: ubuntu-latest
    needs: functional-tests
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            index.php
            admin/index.php
          sparse-checkout-cone-mode: false

      - name: Crear build package
        run: |
          echo "ğŸ—ï¸ CREANDO BUILD PACKAGE..."

          # Crear directorio de build
          mkdir -p build/files

          # Copiar SOLO los archivos objetivo
          cp index.php build/files/
          mkdir -p build/files/admin
          cp admin/index.php build/files/admin/

          # Crear archivo de informaciÃ³n
          cat > build/files/BUILD_INFO.txt << EOF
          Build Date: $(date)
          Build Number: ${{ github.run_number }}
          Commit: ${{ github.sha }}

          Files included:
          - index.php
          - admin/index.php

          Total files: 2
          Workflow: Optimized for specific files only
          No external dependencies analyzed
          EOF

          # Verificar contenido del build
          echo "ğŸ“¦ Contenido del build:"
          find build/ -type f

          # Crear archivo comprimido
          cd build
          tar -czf files-v${{ github.run_number }}.tar.gz files/

          echo "âœ… Build package creado: files-v${{ github.run_number }}.tar.gz"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: files-only-v${{ github.run_number }}
          path: build/
          retention-days: 7

  # ========================================
  # RESUMEN FINAL
  # ========================================
  summary:
    name: Resumen Final
    runs-on: ubuntu-latest
    needs: [basic-analysis, functional-tests]
    if: always()

    steps:
      - name: Generar resumen completo
        run: |
          echo "ğŸ“Š RESUMEN FINAL DEL WORKFLOW OPTIMIZADO"
          echo "=================================================="
          echo ""
          echo "ğŸ¯ ARCHIVOS ANALIZADOS:"
          echo "   âœ… index.php"
          echo "   âœ… admin/index.php"
          echo "   ğŸ“Š Total: 2 archivos Ãºnicamente"
          echo ""
          echo "ğŸ” ANÃLISIS REALIZADOS:"
          echo "   âœ… Sintaxis PHP: ${{ needs.basic-analysis.result }}"
          echo "   âœ… Seguridad bÃ¡sica: ${{ needs.basic-analysis.result }}"
          echo "   âœ… Tests funcionales: ${{ needs.functional-tests.result }}"
          echo ""
          echo "âš¡ OPTIMIZACIONES APLICADAS:"
          echo "   âœ… Sparse checkout (solo archivos objetivo)"
          echo "   âœ… Sin herramientas externas que escaneen todo"
          echo "   âœ… Sin composer dependencies"
          echo "   âœ… Sin vendor/ ni node_modules/"
          echo "   âœ… AnÃ¡lisis manual especÃ­fico"
          echo ""
          echo "ğŸ’¡ RESULTADO:"
          echo "   âœ… 0% de archivos no objetivo analizados"
          echo "   âœ… 100% enfoque en archivos especÃ­ficos"
          echo "   âœ… Tiempo de ejecuciÃ³n mÃ­nimo"
          echo "   âœ… Sin falsos positivos de dependencias"
          echo "
          echo "ğŸš€ ESTE WORKFLOW SOLO ANALIZA 2 ARCHIVOS, NADA MÃS!"
