name: CI/CD - SOLO index.php y admin/index.php (SIN herramientas externas)

on:
  push:
    branches: [main, develop]
    paths:
      - "index.php"
      - "admin/index.php"
      - ".github/workflows/ci-cd.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "index.php"
      - "admin/index.php"
      - ".github/workflows/ci-cd.yml"
  release:
    types: [published]

env:
  PHP_VERSION: "8.2"

jobs:
  # ========================================
  # ANÃLISIS BÃSICO SIN HERRAMIENTAS EXTERNAS
  # ========================================
  basic-analysis:
    name: AnÃ¡lisis BÃ¡sico (SOLO 2 archivos)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            index.php
            admin/index.php
          sparse-checkout-cone-mode: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, mysql, gd, zip, curl, xml, dom, pdo, pdo_mysql

      - name: Verificar archivos objetivo
        run: |
          echo "ğŸ” VERIFICANDO ARCHIVOS OBJETIVO..."

          # Listar TODOS los archivos en el workspace
          echo "ğŸ“ Archivos en el workspace:"
          find . -type f -name "*.php" | head -20

          # Verificar que SOLO tenemos los archivos objetivo
          if [ -f "index.php" ] && [ -f "admin/index.php" ]; then
            echo "âœ… Archivos objetivo encontrados"
          else
            echo "âŒ Archivos objetivo NO encontrados"
            exit 1
          fi

          # Contar archivos PHP
          PHP_COUNT=$(find . -name "*.php" | wc -l)
          echo "ğŸ“Š Total archivos PHP encontrados: $PHP_COUNT"

          if [ $PHP_COUNT -gt 2 ]; then
            echo "âš ï¸ ADVERTENCIA: Se encontraron mÃ¡s archivos PHP de los esperados"
            echo "ğŸ“‹ Lista completa:"
            find . -name "*.php"
          fi

      - name: AnÃ¡lisis de sintaxis PHP
        run: |
          echo "ğŸ§ª ANÃLISIS DE SINTAXIS PHP..."

          # Verificar sintaxis de index.php
          echo "Verificando: index.php"
          php -l index.php || exit 1

          # Verificar sintaxis de admin/index.php
          echo "Verificando: admin/index.php"
          php -l admin/index.php || exit 1

          echo "âœ… Sintaxis PHP correcta en ambos archivos"

      - name: AnÃ¡lisis de cÃ³digo bÃ¡sico (SIN herramientas externas)
        run: |
          echo "ğŸ” ANÃLISIS DE CÃ“DIGO BÃSICO..."

          # FunciÃ³n para analizar un archivo
          analyze_file() {
            local file="$1"
            echo ""
            echo "ğŸ” Analizando: $file"
            echo "----------------------------------------"
            
            # Verificar longitud de lÃ­neas
            echo "ğŸ“ LÃ­neas largas (>120 caracteres):"
            awk 'length > 120 { print NR ": " $0 }' "$file" | head -5 || echo "âœ… No encontradas"
            
            # Verificar espacios en blanco al final
            echo "ğŸ”² Espacios en blanco al final:"
            grep -n " $" "$file" | head -3 || echo "âœ… No encontrados"
            
            # Verificar tabulaciones mixtas
            echo "ğŸ”¤ Tabulaciones mixtas:"
            grep -n $'\t' "$file" | head -3 || echo "âœ… No encontradas"
            
            # Verificar etiquetas PHP
            echo "ğŸ·ï¸ Etiquetas PHP:"
            if grep -q "<?php" "$file"; then
              echo "âœ… Contiene etiquetas PHP"
            else
              echo "âŒ No contiene etiquetas PHP"
            fi
            
            # EstadÃ­sticas bÃ¡sicas
            echo "ğŸ“Š EstadÃ­sticas:"
            echo "   - LÃ­neas: $(wc -l < "$file")"
            echo "   - Palabras: $(wc -w < "$file")"
            echo "   - Caracteres: $(wc -c < "$file")"
          }

          # Analizar solo los archivos objetivo
          analyze_file "index.php"
          analyze_file "admin/index.php"

      - name: AnÃ¡lisis de seguridad bÃ¡sico
        run: |
          echo "ğŸ”’ ANÃLISIS DE SEGURIDAD BÃSICO..."

          # FunciÃ³n para escanear seguridad
          security_scan() {
            local file="$1"
            echo ""
            echo "ğŸ”’ Escaneando: $file"
            echo "----------------------------------------"
            
            # Funciones peligrosas
            echo "ğŸš¨ Funciones peligrosas:"
            grep -n "eval\|exec\|system\|shell_exec\|passthru" "$file" || echo "âœ… No encontradas"
            
            # SQL injection bÃ¡sico
            echo "ğŸ—„ï¸ SQL injection potencial:"
            grep -n "SELECT.*\$_\|INSERT.*\$_\|UPDATE.*\$_\|DELETE.*\$_" "$file" || echo "âœ… No encontrado"
            
            # XSS bÃ¡sico
            echo "ğŸ”— XSS potencial:"
            grep -n "echo.*\$_\|print.*\$_" "$file" || echo "âœ… No encontrado"
            
            # Variables superglobales sin validar
            echo "ğŸŒ Variables superglobales:"
            grep -n "\$_GET\|\$_POST\|\$_REQUEST\|\$_COOKIE" "$file" | head -3 || echo "âœ… No encontradas"
            
            # File inclusion
            echo "ğŸ“‚ File inclusion:"
            grep -n "include.*\$\|require.*\$" "$file" || echo "âœ… No encontrado"
          }

          # Escanear solo archivos objetivo
          security_scan "index.php"
          security_scan "admin/index.php"

  # ========================================
  # TESTS FUNCIONALES BÃSICOS
  # ========================================
  functional-tests:
    name: Tests Funcionales (SOLO 2 archivos)
    runs-on: ubuntu-latest
    needs: basic-analysis

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            index.php
            admin/index.php
          sparse-checkout-cone-mode: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, mysql, gd, zip, curl, xml, dom, pdo, pdo_mysql

      - name: Test estructura de archivos
        run: |
          echo "ğŸ§ª TESTING ESTRUCTURA DE ARCHIVOS..."

          # Verificar que tenemos los archivos objetivo
          if [ -f "index.php" ] && [ -f "admin/index.php" ]; then
            echo "âœ… Archivos objetivo encontrados"
          else
            echo "âŒ Archivos objetivo NO encontrados"
            exit 1
          fi

          # Mostrar total de archivos (pero no fallar si hay mÃ¡s)
          TOTAL_FILES=$(find . -name "*.php" | wc -l)
          echo "ğŸ“Š Total archivos PHP en el proyecto: $TOTAL_FILES"
          echo "ğŸ¯ Solo analizamos: index.php y admin/index.php"

      - name: Test contenido bÃ¡sico
        run: |
          echo "ğŸ§ª TESTING CONTENIDO BÃSICO..."

          # Test para index.php
          echo "Testing index.php:"
          if [ -s "index.php" ]; then
            echo "âœ… index.php tiene contenido"
            # Verificar que es un archivo PHP vÃ¡lido
            if head -1 "index.php" | grep -q "<?php"; then
              echo "âœ… index.php comienza con <?php"
            else
              echo "âš ï¸ index.php no comienza con <?php"
            fi
          else
            echo "âŒ index.php estÃ¡ vacÃ­o"
            exit 1
          fi

          # Test para admin/index.php
          echo "Testing admin/index.php:"
          if [ -s "admin/index.php" ]; then
            echo "âœ… admin/index.php tiene contenido"
            # Verificar que es un archivo PHP vÃ¡lido
            if head -1 "admin/index.php" | grep -q "<?php"; then
              echo "âœ… admin/index.php comienza con <?php"
            else
              echo "âš ï¸ admin/index.php no comienza con <?php"
            fi
          else
            echo "âŒ admin/index.php estÃ¡ vacÃ­o"
            exit 1
          fi

      - name: Test parsing PHP
        run: |
          echo "ğŸ§ª TESTING PARSING PHP..."

          # Crear script de test temporal
          cat > test_parse.php << 'EOF'
          <?php
          $files = ['index.php', 'admin/index.php'];

          foreach ($files as $file) {
            echo "Parseando: $file\n";
            
            $content = file_get_contents($file);
            if ($content === false) {
              echo "âŒ Error leyendo $file\n";
              exit(1);
            }
            
            // Verificar que no hay errores de sintaxis bÃ¡sicos
            $tokens = token_get_all($content);
            if (empty($tokens)) {
              echo "âŒ Error parseando $file\n";
              exit(1);
            }
            
            echo "âœ… $file parseado correctamente\n";
          }

          echo "âœ… Todos los archivos parseados correctamente\n";
          EOF

          php test_parse.php

  # ========================================
  # BUILD COMPLETO DEL SISTEMA
  # ========================================
  build:
    name: Build Completo del Sistema
    runs-on: ubuntu-latest
    needs: functional-tests
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
      - name: Checkout cÃ³digo completo
        uses: actions/checkout@v4

      - name: Crear build package completo
        run: |
          echo "ğŸ—ï¸ CREANDO BUILD PACKAGE COMPLETO..."

          # Crear directorio de build
          mkdir -p build/files

          # Copiar TODO el sistema web
          echo "ğŸ“ Copiando todo el sistema web..."
          cp -r * build/files/ 2>/dev/null || true
          cp -r .* build/files/ 2>/dev/null || true

          # Remover archivos que no deben ir al servidor
          echo "ğŸ§¹ Limpiando archivos innecesarios..."
          cd build/files
          rm -rf .git .github .idea .gitignore .gitattributes .php-cs-fixer.cache 2>/dev/null || true
          rm -rf node_modules vendor/composer vendor/autoload.php 2>/dev/null || true

          # Crear archivo de informaciÃ³n
          cat > BUILD_INFO.txt << EOF
          Build Date: $(date)
          Build Number: ${{ github.run_number }}
          Commit: ${{ github.sha }}

          Sistema Web Completo Desplegado
          - AnÃ¡lisis realizado en: index.php y admin/index.php
          - Despliegue: TODO el sistema web

          Archivos principales incluidos:
          - index.php
          - admin/index.php
          - Todos los archivos PHP del sistema
          - Assets (CSS, JS, imÃ¡genes)
          - Configuraciones
          - Y todo el resto del sistema
          EOF

          # Verificar contenido del build
          echo "ğŸ“¦ Contenido del build:"
          echo "ğŸ“Š Total archivos: $(find . -type f | wc -l)"
          echo "ğŸ“ Directorios principales:"
          ls -la | head -10

          # Crear archivo comprimido
          cd ..
          tar -czf sistema-completo-v${{ github.run_number }}.tar.gz files/

          echo "âœ… Build package completo creado: sistema-completo-v${{ github.run_number }}.tar.gz"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sistema-completo-v${{ github.run_number }}
          path: build/
          retention-days: 7

  # ========================================
  # DESPLIEGUE FTP
  # ========================================
  deploy:
    name: Despliegue FTP (SOLO 2 archivos)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sistema-completo-v${{ github.run_number }}
          path: build/

      - name: Desplegar a FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./build/files/
          server-dir: ${{ secrets.FTP_TARGET_DIR }}

      - name: Verificar despliegue
        run: |
          echo "âœ… DESPLIEGUE COMPLETO DEL SISTEMA"
          echo "ğŸ“ Sistema web completo desplegado:"
          echo "   - index.php"
          echo "   - admin/index.php"
          echo "   - Todos los archivos PHP del sistema"
          echo "   - Assets (CSS, JS, imÃ¡genes)"
          echo "   - Configuraciones y base de datos"
          echo "   - Y todo el resto del sistema web"
          echo "ğŸŒ Servidor: ${{ secrets.FTP_SERVER }}"
          echo "ğŸ“‚ Directorio: ${{ secrets.FTP_TARGET_DIR }}"
          echo "ğŸ“Š Total archivos desplegados: $(find ./build/files -type f | wc -l)"

  # ========================================
  # RESUMEN FINAL
  # ========================================
  summary:
    name: Resumen Final
    runs-on: ubuntu-latest
    needs: [basic-analysis, functional-tests, build, deploy]
    if: always()

    steps:
      - name: Generar resumen completo
        run: |
          echo "ğŸ“Š RESUMEN FINAL DEL WORKFLOW OPTIMIZADO"
          echo "=================================================="
          echo ""
          echo "ğŸ¯ ANÃLISIS Y DESPLIEGUE:"
          echo "   âœ… AnÃ¡lisis: Solo index.php y admin/index.php"
          echo "   âœ… Despliegue: TODO el sistema web completo"
          echo "   ğŸ“Š OptimizaciÃ³n: AnÃ¡lisis rÃ¡pido, despliegue completo"
          echo ""
          echo "ğŸ” ANÃLISIS REALIZADOS:"
          echo "   âœ… Sintaxis PHP: ${{ needs.basic-analysis.result }}"
          echo "   âœ… Seguridad bÃ¡sica: ${{ needs.basic-analysis.result }}"
          echo "   âœ… Tests funcionales: ${{ needs.functional-tests.result }}"
          echo "   âœ… Build creado: ${{ needs.build.result }}"
          echo "   âœ… Despliegue FTP: ${{ needs.deploy.result }}"
          echo ""
          echo "âš¡ OPTIMIZACIONES APLICADAS:"
          echo "   âœ… Sparse checkout (solo archivos objetivo)"
          echo "   âœ… Sin herramientas externas que escaneen todo"
          echo "   âœ… Sin composer dependencies"
          echo "   âœ… Sin vendor/ ni node_modules/"
          echo "   âœ… AnÃ¡lisis manual especÃ­fico"
          echo ""
          echo "ğŸ’¡ RESULTADO:"
          echo "   âœ… AnÃ¡lisis rÃ¡pido: Solo 2 archivos crÃ­ticos"
          echo "   âœ… Despliegue completo: Todo el sistema web"
          echo "   âœ… Tiempo de ejecuciÃ³n optimizado"
          echo "   âœ… Sin falsos positivos de dependencias"
          echo "   âœ… Despliegue automÃ¡tico completo a FTP"
          echo ""
          echo "ğŸš€ ANÃLISIS RÃPIDO + DESPLIEGUE COMPLETO DEL SISTEMA!"
