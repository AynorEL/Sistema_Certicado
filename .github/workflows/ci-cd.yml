name: CI/CD - SOLO index.php y admin/index.php (SIN herramientas externas)

on:
  push:
    branches: [main, develop]
    paths:
      - "index.php"
      - "admin/index.php"
      - ".github/workflows/ci-cd.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "index.php"
      - "admin/index.php"
      - ".github/workflows/ci-cd.yml"
  release:
    types: [published]

env:
  PHP_VERSION: "8.2"

jobs:
  # ========================================
  # ANÁLISIS BÁSICO SIN HERRAMIENTAS EXTERNAS
  # ========================================
  basic-analysis:
    name: Análisis Básico (SOLO 2 archivos)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            index.php
            admin/index.php
          sparse-checkout-cone-mode: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, mysql, gd, zip, curl, xml, dom, pdo, pdo_mysql

      - name: Verificar archivos objetivo
        run: |
          echo "🔍 VERIFICANDO ARCHIVOS OBJETIVO..."

          # Listar TODOS los archivos en el workspace
          echo "📁 Archivos en el workspace:"
          find . -type f -name "*.php" | head -20

          # Verificar que SOLO tenemos los archivos objetivo
          if [ -f "index.php" ] && [ -f "admin/index.php" ]; then
            echo "✅ Archivos objetivo encontrados"
          else
            echo "❌ Archivos objetivo NO encontrados"
            exit 1
          fi

          # Contar archivos PHP
          PHP_COUNT=$(find . -name "*.php" | wc -l)
          echo "📊 Total archivos PHP encontrados: $PHP_COUNT"

          if [ $PHP_COUNT -gt 2 ]; then
            echo "⚠️ ADVERTENCIA: Se encontraron más archivos PHP de los esperados"
            echo "📋 Lista completa:"
            find . -name "*.php"
          fi

      - name: Análisis de sintaxis PHP
        run: |
          echo "🧪 ANÁLISIS DE SINTAXIS PHP..."

          # Verificar sintaxis de index.php
          echo "Verificando: index.php"
          php -l index.php || exit 1

          # Verificar sintaxis de admin/index.php
          echo "Verificando: admin/index.php"
          php -l admin/index.php || exit 1

          echo "✅ Sintaxis PHP correcta en ambos archivos"

      - name: Análisis de código básico (SIN herramientas externas)
        run: |
          echo "🔍 ANÁLISIS DE CÓDIGO BÁSICO..."

          # Función para analizar un archivo
          analyze_file() {
            local file="$1"
            echo ""
            echo "🔍 Analizando: $file"
            echo "----------------------------------------"
            
            # Verificar longitud de líneas
            echo "📏 Líneas largas (>120 caracteres):"
            awk 'length > 120 { print NR ": " $0 }' "$file" | head -5 || echo "✅ No encontradas"
            
            # Verificar espacios en blanco al final
            echo "🔲 Espacios en blanco al final:"
            grep -n " $" "$file" | head -3 || echo "✅ No encontrados"
            
            # Verificar tabulaciones mixtas
            echo "🔤 Tabulaciones mixtas:"
            grep -n $'\t' "$file" | head -3 || echo "✅ No encontradas"
            
            # Verificar etiquetas PHP
            echo "🏷️ Etiquetas PHP:"
            if grep -q "<?php" "$file"; then
              echo "✅ Contiene etiquetas PHP"
            else
              echo "❌ No contiene etiquetas PHP"
            fi
            
            # Estadísticas básicas
            echo "📊 Estadísticas:"
            echo "   - Líneas: $(wc -l < "$file")"
            echo "   - Palabras: $(wc -w < "$file")"
            echo "   - Caracteres: $(wc -c < "$file")"
          }

          # Analizar solo los archivos objetivo
          analyze_file "index.php"
          analyze_file "admin/index.php"

      - name: Análisis de seguridad básico
        run: |
          echo "🔒 ANÁLISIS DE SEGURIDAD BÁSICO..."

          # Función para escanear seguridad
          security_scan() {
            local file="$1"
            echo ""
            echo "🔒 Escaneando: $file"
            echo "----------------------------------------"
            
            # Funciones peligrosas
            echo "🚨 Funciones peligrosas:"
            grep -n "eval\|exec\|system\|shell_exec\|passthru" "$file" || echo "✅ No encontradas"
            
            # SQL injection básico
            echo "🗄️ SQL injection potencial:"
            grep -n "SELECT.*\$_\|INSERT.*\$_\|UPDATE.*\$_\|DELETE.*\$_" "$file" || echo "✅ No encontrado"
            
            # XSS básico
            echo "🔗 XSS potencial:"
            grep -n "echo.*\$_\|print.*\$_" "$file" || echo "✅ No encontrado"
            
            # Variables superglobales sin validar
            echo "🌐 Variables superglobales:"
            grep -n "\$_GET\|\$_POST\|\$_REQUEST\|\$_COOKIE" "$file" | head -3 || echo "✅ No encontradas"
            
            # File inclusion
            echo "📂 File inclusion:"
            grep -n "include.*\$\|require.*\$" "$file" || echo "✅ No encontrado"
          }

          # Escanear solo archivos objetivo
          security_scan "index.php"
          security_scan "admin/index.php"

  # ========================================
  # TESTS FUNCIONALES BÁSICOS
  # ========================================
  functional-tests:
    name: Tests Funcionales (SOLO 2 archivos)
    runs-on: ubuntu-latest
    needs: basic-analysis

    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            index.php
            admin/index.php
          sparse-checkout-cone-mode: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, mysql, gd, zip, curl, xml, dom, pdo, pdo_mysql

      - name: Test estructura de archivos
        run: |
          echo "🧪 TESTING ESTRUCTURA DE ARCHIVOS..."

          # Verificar que tenemos los archivos objetivo
          if [ -f "index.php" ] && [ -f "admin/index.php" ]; then
            echo "✅ Archivos objetivo encontrados"
          else
            echo "❌ Archivos objetivo NO encontrados"
            exit 1
          fi

          # Mostrar total de archivos (pero no fallar si hay más)
          TOTAL_FILES=$(find . -name "*.php" | wc -l)
          echo "📊 Total archivos PHP en el proyecto: $TOTAL_FILES"
          echo "🎯 Solo analizamos: index.php y admin/index.php"

      - name: Test contenido básico
        run: |
          echo "🧪 TESTING CONTENIDO BÁSICO..."

          # Test para index.php
          echo "Testing index.php:"
          if [ -s "index.php" ]; then
            echo "✅ index.php tiene contenido"
            # Verificar que es un archivo PHP válido
            if head -1 "index.php" | grep -q "<?php"; then
              echo "✅ index.php comienza con <?php"
            else
              echo "⚠️ index.php no comienza con <?php"
            fi
          else
            echo "❌ index.php está vacío"
            exit 1
          fi

          # Test para admin/index.php
          echo "Testing admin/index.php:"
          if [ -s "admin/index.php" ]; then
            echo "✅ admin/index.php tiene contenido"
            # Verificar que es un archivo PHP válido
            if head -1 "admin/index.php" | grep -q "<?php"; then
              echo "✅ admin/index.php comienza con <?php"
            else
              echo "⚠️ admin/index.php no comienza con <?php"
            fi
          else
            echo "❌ admin/index.php está vacío"
            exit 1
          fi

      - name: Test parsing PHP
        run: |
          echo "🧪 TESTING PARSING PHP..."

          # Crear script de test temporal
          cat > test_parse.php << 'EOF'
          <?php
          $files = ['index.php', 'admin/index.php'];

          foreach ($files as $file) {
            echo "Parseando: $file\n";
            
            $content = file_get_contents($file);
            if ($content === false) {
              echo "❌ Error leyendo $file\n";
              exit(1);
            }
            
            // Verificar que no hay errores de sintaxis básicos
            $tokens = token_get_all($content);
            if (empty($tokens)) {
              echo "❌ Error parseando $file\n";
              exit(1);
            }
            
            echo "✅ $file parseado correctamente\n";
          }

          echo "✅ Todos los archivos parseados correctamente\n";
          EOF

          php test_parse.php

  # ========================================
  # BUILD COMPLETO DEL SISTEMA
  # ========================================
  build:
    name: Build Completo del Sistema
    runs-on: ubuntu-latest
    needs: functional-tests
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
      - name: Checkout código completo
        uses: actions/checkout@v4

      - name: Crear build package completo
        run: |
          echo "🏗️ CREANDO BUILD PACKAGE COMPLETO..."

          # Crear directorio de build
          mkdir -p build/files

          # Copiar TODO el sistema web
          echo "📁 Copiando todo el sistema web..."
          cp -r * build/files/ 2>/dev/null || true
          cp -r .* build/files/ 2>/dev/null || true

          # Remover archivos que no deben ir al servidor
          echo "🧹 Limpiando archivos innecesarios..."
          cd build/files
          rm -rf .git .github .idea .gitignore .gitattributes .php-cs-fixer.cache 2>/dev/null || true
          rm -rf node_modules vendor/composer vendor/autoload.php 2>/dev/null || true

          # Crear archivo de información
          cat > BUILD_INFO.txt << EOF
          Build Date: $(date)
          Build Number: ${{ github.run_number }}
          Commit: ${{ github.sha }}

          Sistema Web Completo Desplegado
          - Análisis realizado en: index.php y admin/index.php
          - Despliegue: TODO el sistema web

          Archivos principales incluidos:
          - index.php
          - admin/index.php
          - Todos los archivos PHP del sistema
          - Assets (CSS, JS, imágenes)
          - Configuraciones
          - Y todo el resto del sistema
          EOF

          # Verificar contenido del build
          echo "📦 Contenido del build:"
          echo "📊 Total archivos: $(find . -type f | wc -l)"
          echo "📁 Directorios principales:"
          ls -la | head -10

          # Crear archivo comprimido
          cd ..
          tar -czf sistema-completo-v${{ github.run_number }}.tar.gz files/

          echo "✅ Build package completo creado: sistema-completo-v${{ github.run_number }}.tar.gz"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sistema-completo-v${{ github.run_number }}
          path: build/
          retention-days: 7

  # ========================================
  # DESPLIEGUE FTP
  # ========================================
  deploy:
    name: Despliegue FTP (SOLO 2 archivos)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sistema-completo-v${{ github.run_number }}
          path: build/

      - name: Desplegar a FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./build/files/
          server-dir: ${{ secrets.FTP_TARGET_DIR }}

      - name: Verificar despliegue
        run: |
          echo "✅ DESPLIEGUE COMPLETO DEL SISTEMA"
          echo "📁 Sistema web completo desplegado:"
          echo "   - index.php"
          echo "   - admin/index.php"
          echo "   - Todos los archivos PHP del sistema"
          echo "   - Assets (CSS, JS, imágenes)"
          echo "   - Configuraciones y base de datos"
          echo "   - Y todo el resto del sistema web"
          echo "🌐 Servidor: ${{ secrets.FTP_SERVER }}"
          echo "📂 Directorio: ${{ secrets.FTP_TARGET_DIR }}"
          echo "📊 Total archivos desplegados: $(find ./build/files -type f | wc -l)"

  # ========================================
  # RESUMEN FINAL
  # ========================================
  summary:
    name: Resumen Final
    runs-on: ubuntu-latest
    needs: [basic-analysis, functional-tests, build, deploy]
    if: always()

    steps:
      - name: Generar resumen completo
        run: |
          echo "📊 RESUMEN FINAL DEL WORKFLOW OPTIMIZADO"
          echo "=================================================="
          echo ""
          echo "🎯 ANÁLISIS Y DESPLIEGUE:"
          echo "   ✅ Análisis: Solo index.php y admin/index.php"
          echo "   ✅ Despliegue: TODO el sistema web completo"
          echo "   📊 Optimización: Análisis rápido, despliegue completo"
          echo ""
          echo "🔍 ANÁLISIS REALIZADOS:"
          echo "   ✅ Sintaxis PHP: ${{ needs.basic-analysis.result }}"
          echo "   ✅ Seguridad básica: ${{ needs.basic-analysis.result }}"
          echo "   ✅ Tests funcionales: ${{ needs.functional-tests.result }}"
          echo "   ✅ Build creado: ${{ needs.build.result }}"
          echo "   ✅ Despliegue FTP: ${{ needs.deploy.result }}"
          echo ""
          echo "⚡ OPTIMIZACIONES APLICADAS:"
          echo "   ✅ Sparse checkout (solo archivos objetivo)"
          echo "   ✅ Sin herramientas externas que escaneen todo"
          echo "   ✅ Sin composer dependencies"
          echo "   ✅ Sin vendor/ ni node_modules/"
          echo "   ✅ Análisis manual específico"
          echo ""
          echo "💡 RESULTADO:"
          echo "   ✅ Análisis rápido: Solo 2 archivos críticos"
          echo "   ✅ Despliegue completo: Todo el sistema web"
          echo "   ✅ Tiempo de ejecución optimizado"
          echo "   ✅ Sin falsos positivos de dependencias"
          echo "   ✅ Despliegue automático completo a FTP"
          echo ""
          echo "🚀 ANÁLISIS RÁPIDO + DESPLIEGUE COMPLETO DEL SISTEMA!"
